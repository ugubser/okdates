<div class="availability-timeline">
  <table mat-table [dataSource]="participants" class="availability-matrix">
    <!-- Participant Column -->
    <ng-container matColumnDef="participant">
      <th mat-header-cell *matHeaderCellDef>Participant</th>
      <td mat-cell *matCellDef="let participant">{{ participant.name }}</td>
      <td mat-footer-cell *matFooterCellDef [class.selection-row-label]="mode === 'select'">
        <span *ngIf="mode === 'view'">Available:</span>
        <span *ngIf="mode === 'select'">Your Availability</span>
      </td>
    </ng-container>

    <!-- Available Label Column for Footer -->
    <ng-container matColumnDef="available">
      <td mat-footer-cell *matFooterCellDef [class.selection-row-label]="mode === 'select'">
        <span *ngIf="mode === 'view'">Available:</span>
        <span *ngIf="mode === 'select'">Your Availability</span>
      </td>
    </ng-container>

    <!-- Dynamic Date Columns -->
    <ng-container *ngFor="let dateInfo of uniqueDates" [matColumnDef]="dateInfo.dateString">
      <th mat-header-cell *matHeaderCellDef
          [ngClass]="[
            getParticipationClass(dateInfo.dateString),
            event.isMeeting ? 'time-slot' : '',
            event.isMeeting && isCommonAvailableSlot(dateInfo.dateString) ? 'common-available-slot' : ''
          ]">
        <div class="date-header">
          <!-- Regular event view - simple date display -->
          <span *ngIf="!event.isMeeting">{{ dateInfo.formattedDate }}</span>

          <!-- Meeting view - time slot display -->
          <div *ngIf="event.isMeeting" class="time-slot-container">
            <span class="day-display" *ngIf="isFirstTimeSlotOfDay(dateInfo)">
              {{ formatDayOnly(dateInfo.date) }}
            </span>
            <span class="time-display">{{ dateInfo.formattedDate | slice:dateInfo.formattedDate.lastIndexOf(' ') + 1 }}</span>
            <span class="timezone-display" *ngIf="dateInfo.timezone">{{ dateInfo.timezone }}</span>
            <span class="common-available-badge" *ngIf="isCommonAvailableSlot(dateInfo.dateString)">Available for All</span>
          </div>
        </div>
      </th>
      <td mat-cell *matCellDef="let participant" [ngClass]="getParticipationClass(dateInfo.dateString)">
        <div
          class="availability-indicator"
          [ngClass]="getAvailabilityClass(isParticipantAvailable(participant, dateInfo.dateString))">
        </div>
      </td>
      <td mat-footer-cell *matFooterCellDef
          [ngClass]="[
            'percentage-cell',
            getParticipationClass(dateInfo.dateString),
            mode === 'select' ? 'selectable-cell' : ''
          ]"
          (click)="toggleSlot(dateInfo.dateString)">
        <!-- View mode: show percentage -->
        <div class="footer-cell-content" *ngIf="mode === 'view'">
          <span>{{ Math.round((getAvailableCountForDate(dateInfo.dateString) / participants.length) * 100) }}%</span>
        </div>
        <!-- Select mode: show selection indicator -->
        <div class="selection-indicator" *ngIf="mode === 'select'">
          <mat-icon *ngIf="isSelected(dateInfo.dateString)">check_circle</mat-icon>
          <mat-icon *ngIf="!isSelected(dateInfo.dateString)">radio_button_unchecked</mat-icon>
        </div>
      </td>
    </ng-container>

    <!-- Header and regular rows -->
    <tr mat-header-row *matHeaderRowDef="displayColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayColumns;"></tr>

    <!-- Footer row -->
    <tr mat-footer-row *matFooterRowDef="footerColumns; sticky: true"
        [ngClass]="mode === 'select' ? 'selection-row' : ''"></tr>
  </table>
</div>
